#!/bin/bash

set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
DOWNLOAD_URI=$(cat ${ENV_DIR}/MATTERMOST_DOWNLOAD_URI)


echo "-----> Build DIR: ${BUILD_DIR}"
echo "-----> Cache DIR: ${CACHE_DIR}"
echo "-----> Env DIR: ${ENV_DIR}"
echo "-----> Mattermost URI: ${MATTERMOST_DOWNLOAD_URI}"
echo "-----> Current DIR:"
pwd

echo "-----> Retrieving mattermost tar from ${DOWNLOAD_URI}"
curl -s -L "${DOWNLOAD_URI}" | tar -zxf - --strip-components=1 -C ${BUILD_DIR}

echo "-----> Remove large plugins not required"
rm ${BUILD_DIR}/prepackaged_plugins/mattermost-plugin-msteams-*
rm ${BUILD_DIR}/prepackaged_plugins/mattermost-plugin-boards-*
rm ${BUILD_DIR}/prepackaged_plugins/mattermost-plugin-playbooks-*
rm ${BUILD_DIR}/prepackaged_plugins/mattermost-plugin-gitlab-*
rm ${BUILD_DIR}/prepackaged_plugins/mattermost-plugin-mscalendar-*

mkdir -p ${BUILD_DIR}/data/
